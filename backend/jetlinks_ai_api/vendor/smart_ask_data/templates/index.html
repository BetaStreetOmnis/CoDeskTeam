{% raw %}
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智能问数 - 广东省消防救援总队数据治理（2024）项目</title>

    <link href="static/vendor/ant-design-vue/reset.css" rel="stylesheet" />
    <link href="static/app_shell.css" rel="stylesheet" />
    <script src="static/vendor/vue/vue.global.prod.js"></script>
    <script src="static/vendor/dayjs/dayjs.min.js"></script>
    <script src="static/vendor/dayjs/plugin/advancedFormat.js"></script>
    <script src="static/vendor/dayjs/plugin/customParseFormat.js"></script>
    <script src="static/vendor/dayjs/plugin/quarterOfYear.js"></script>
    <script src="static/vendor/dayjs/plugin/weekday.js"></script>
    <script src="static/vendor/dayjs/plugin/localeData.js"></script>
    <script src="static/vendor/dayjs/plugin/weekOfYear.js"></script>
    <script src="static/vendor/dayjs/plugin/weekYear.js"></script>
    <script>
      if (window.dayjs_plugin_advancedFormat) dayjs.extend(window.dayjs_plugin_advancedFormat);
      if (window.dayjs_plugin_customParseFormat) dayjs.extend(window.dayjs_plugin_customParseFormat);
      if (window.dayjs_plugin_quarterOfYear) dayjs.extend(window.dayjs_plugin_quarterOfYear);
      if (window.dayjs_plugin_weekday) dayjs.extend(window.dayjs_plugin_weekday);
      if (window.dayjs_plugin_localeData) dayjs.extend(window.dayjs_plugin_localeData);
      if (window.dayjs_plugin_weekOfYear) dayjs.extend(window.dayjs_plugin_weekOfYear);
      if (window.dayjs_plugin_weekYear) dayjs.extend(window.dayjs_plugin_weekYear);
    </script>
    <script src="static/vendor/ant-design-vue/antd-with-locales.min.js"></script>
    <script src="static/vendor/echarts/echarts.min.js"></script>
    <script src="static/vendor/xlsx/xlsx.full.min.js"></script>

    <style>
      :root {
        --bg: #f8fafc;
        --text: #0f172a;
        --muted: #64748b;
        --border: rgba(15, 23, 42, 0.10);
        --surface: rgba(255, 255, 255, 0.82);
        --surface2: rgba(255, 255, 255, 0.62);
        --shadow: 0 18px 60px rgba(15, 23, 42, 0.12);
        --shadow-sm: 0 14px 42px rgba(15, 23, 42, 0.10);
        --radius: 16px;
        --primary: #2563eb;
        --primary2: #06b6d4;
        --accent: #22c55e;
      }

      [v-cloak] { display: none; }
      .boot-loading {
        flex: 1;
        min-width: 0;
        margin: 18px;
        border-radius: 16px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(255, 255, 255, 0.82);
        box-shadow: var(--shadow);
        height: calc(100vh - 74px - 36px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 13px;
      }
      #app:not([v-cloak]) + .boot-loading { display: none; }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        background:
          radial-gradient(1200px circle at 10% -10%, rgba(37, 99, 235, 0.14) 0%, rgba(37, 99, 235, 0) 60%),
          radial-gradient(900px circle at 100% 0%, rgba(6, 182, 212, 0.10) 0%, rgba(6, 182, 212, 0) 55%),
          linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      .app { min-height: 100vh; display: flex; flex-direction: column; }

      .header {
        position: sticky;
        top: 0;
        z-index: 10;
        height: 72px;
        background: var(--surface);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }
      .header::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary) 0%, var(--primary2) 55%, var(--accent) 100%);
      }
      .header > * { position: relative; }

      .brand { display: flex; align-items: center; gap: 12px; }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
        box-shadow: 0 16px 36px rgba(79, 70, 229, 0.28);
        display:flex;
        align-items:center;
        justify-content:center;
        color:#fff;
        font-weight: 900;
        letter-spacing: 0.6px;
      }
      .brand-title { font-weight: 800; color: var(--text); letter-spacing: 0.2px; }

      .main {
        flex: 1;
        width: min(1400px, 100%);
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 16px;
        padding: 18px;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }
      .card-hd {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        display:flex;
        align-items:center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.62);
      }
      .card-bd { padding: 16px; }

      .muted { color: var(--muted); font-size: 12px; }

      /* light shell override (keep pages separate but same platform) */
      .sidebar {
        background: rgba(255, 255, 255, 0.78);
        border-right: 1px solid rgba(15, 23, 42, 0.10);
      }
      .side-brand {
        border-color: rgba(15, 23, 42, 0.10);
        background: rgba(255, 255, 255, 0.72);
        box-shadow: 0 14px 36px rgba(15, 23, 42, 0.10);
      }
      .side-logo {
        background: linear-gradient(135deg, rgba(37, 99, 235, 1) 0%, rgba(6, 182, 212, 1) 100%);
      }
      .side-title { color: #0f172a; }
      .side-sub { color: #64748b; }
      .side-link {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.10);
        background: rgba(255, 255, 255, 0.72);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }
      .side-link:hover { border-color: rgba(37, 99, 235, 0.28); box-shadow: 0 16px 42px rgba(15, 23, 42, 0.10); }
      .side-link.active {
        border-color: rgba(37, 99, 235, 0.40);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.12) 0%, rgba(6, 182, 212, 0.08) 100%);
        box-shadow: 0 18px 56px rgba(15, 23, 42, 0.12);
      }
      .side-badge {
        color: rgba(37, 99, 235, 1);
        background: rgba(37, 99, 235, 0.08);
        border-color: rgba(37, 99, 235, 0.18);
      }
      .side-tip {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.72);
        color: #64748b;
      }
      .side-tip b { color: #0f172a; }

      .ds-list { display:flex; flex-direction:column; gap: 10px; }
      .ds-item {
        display:flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      }
      .ant-checkbox-wrapper:hover .ds-item {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.10);
      }
      .ant-checkbox-wrapper-checked .ds-item {
        border-color: rgba(37, 99, 235, 0.35);
        box-shadow: 0 16px 36px rgba(37, 99, 235, 0.14);
      }
      .ds-title { font-weight: 750; display:flex; align-items:center; gap: 8px; }
      .badge {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
        border: 1px solid rgba(37, 99, 235, 0.18);
      }
      .ds-desc { color: var(--muted); font-size: 12px; }
      .ds-skel { height: 64px; border-radius: 14px; background: linear-gradient(90deg, rgba(15,23,42,0.04) 0%, rgba(15,23,42,0.08) 35%, rgba(15,23,42,0.04) 70%); background-size: 200% 100%; animation: shimmer 1.1s infinite; border: 1px solid rgba(15,23,42,0.08); }

      .kpi-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-top: 10px; }
      .kpi {
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid var(--border);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08);
        transition: transform .12s ease, border-color .12s ease;
      }
      .kpi:hover { transform: translateY(-1px); border-color: rgba(37, 99, 235, 0.25); }
      .kpi-label { color: var(--muted); font-size: 12px; display:flex; align-items:center; justify-content:space-between; gap: 8px; }
      .kpi-value { font-size: 18px; font-weight: 900; letter-spacing: .2px; margin-top: 6px; }
      .kpi-sub { color: var(--muted); font-size: 11px; margin-top: 2px; }
      .kpi-skeleton { height: 54px; border-radius: 14px; background: linear-gradient(90deg, rgba(15,23,42,0.04) 0%, rgba(15,23,42,0.08) 35%, rgba(15,23,42,0.04) 70%); background-size: 200% 100%; animation: shimmer 1.1s infinite; border: 1px solid rgba(15,23,42,0.08); }
      @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: -200% 0; } }

      .examples { display:flex; flex-wrap: wrap; gap: 8px; }
      .ex-tag { cursor: pointer; border-radius: 999px; user-select: none; }
      .ex-tag:hover { color: var(--primary); border-color: rgba(37, 99, 235, 0.28); }
      .examples-row { display:flex; align-items:center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
      .tag-skel { height: 28px; border-radius: 999px; background: linear-gradient(90deg, rgba(15,23,42,0.04) 0%, rgba(15,23,42,0.08) 35%, rgba(15,23,42,0.04) 70%); background-size: 200% 100%; animation: shimmer 1.1s infinite; border: 1px solid rgba(15,23,42,0.08); }

      .chat { display:flex; flex-direction: column; min-height: calc(100vh - 72px - 36px); }
      .chat-log {
        flex: 1;
        overflow: auto;
        padding: 14px 16px;
        background:
          radial-gradient(900px circle at 12% 0%, rgba(37, 99, 235, 0.08) 0%, rgba(37, 99, 235, 0) 60%),
          radial-gradient(800px circle at 100% 30%, rgba(6, 182, 212, 0.06) 0%, rgba(6, 182, 212, 0) 60%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.62) 0%, rgba(255, 255, 255, 0.42) 100%);
      }
      .msg { display:flex; gap: 10px; margin: 12px 0; align-items: flex-end; }
      .msg.user { flex-direction: row-reverse; }
      .avatar {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight: 900;
        font-size: 12px;
        flex: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.82);
        color: var(--text);
      }
      .avatar.ai {
        background: rgba(37, 99, 235, 0.10);
        border-color: rgba(37, 99, 235, 0.22);
        color: var(--primary);
      }
      .bubble {
        max-width: 78%;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: 0 14px 34px rgba(15, 23, 42, 0.10);
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.82);
      }
      .bubble.wide { max-width: 100%; }
      .msg.user .bubble {
        color: #fff;
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
        box-shadow: 0 18px 44px rgba(37, 99, 235, 0.24);
      }

      .typing { display:inline-flex; gap: 4px; vertical-align: middle; }
      .typing i {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(37, 99, 235, 0.55);
        animation: blink 1.1s infinite ease-in-out;
      }
      .typing i:nth-child(2) { animation-delay: 0.15s; }
      .typing i:nth-child(3) { animation-delay: 0.3s; }
      @keyframes blink {
        0%, 100% { opacity: .25; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-2px); }
      }

      .chat-input {
        padding: 14px 16px;
        border-top: 1px solid rgba(15, 23, 42, 0.08);
        background: var(--surface2);
      }
      .chat-toolbar { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
      .chat-toolbar-group { display:flex; align-items:center; gap: 6px; }

      .result-wrap { margin-top: 12px; padding-top: 10px; border-top: 1px dashed rgba(15, 23, 42, 0.18); }
      .result-wrap:first-child { margin-top: 0; padding-top: 0; border-top: none; }
      .result-head { display:flex; align-items:center; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
      .result-meta { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }
      .panel {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.82);
        padding: 12px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      }
      .result-grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
      .sql-box .ant-input {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        border-radius: 12px;
        background: #f8fafc;
        border-color: rgba(15, 23, 42, 0.12);
      }
      .chart {
        width: 100%;
        height: 360px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(255, 255, 255, 0.82);
      }

      .ant-segmented { background: rgba(37, 99, 235, 0.08); border-radius: 999px; }
      .ant-table { border-radius: 14px; overflow: hidden; }
      .ant-btn { border-radius: 12px; }
      .ant-btn-primary {
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
      }
      .ant-btn-primary:hover { opacity: 0.95; }
      .ant-btn-default {
        background: rgba(255, 255, 255, 0.82);
        border-color: rgba(15, 23, 42, 0.14);
        color: var(--text);
      }
      .ant-btn-default:hover {
        border-color: rgba(37, 99, 235, 0.35);
        color: var(--text);
      }
      .ant-tag {
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.82);
        border-color: rgba(15, 23, 42, 0.12);
        color: var(--text);
      }
      .ant-input, .ant-input-affix-wrapper { border-radius: 12px; }
      .ant-input, .ant-input-affix-wrapper {
        background: rgba(255, 255, 255, 0.82);
        border-color: rgba(15, 23, 42, 0.14);
        color: var(--text);
      }
      .ant-input::placeholder { color: rgba(100, 116, 139, 0.85); }

      @media (max-width: 1100px) {
        .main { grid-template-columns: 1fr; }
        .chat { min-height: auto; }
        .result-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <aside class="sidebar">
        <div class="side-brand">
          <div class="side-logo" data-brand="sideLogo">粤消</div>
          <div>
            <div class="side-title" data-brand="projectName">广东省消防救援总队数据治理（2024）项目</div>
          </div>
        </div>
        <nav class="side-nav">
          <a class="side-link active" href="./"><span>智能问数</span><span class="side-badge">AI</span></a>
          <a class="side-link" href="./datasources"><span>数据源</span><span class="side-badge">DATA</span></a>
          <a class="side-link" href="./data-dev"><span>数据开发</span><span class="side-badge">DEV</span></a>
          <a class="side-link" href="./dashboard"><span>图表大屏</span><span class="side-badge">BI</span></a>
        </nav>
      </aside>
      <div id="app" class="app shell-content" v-cloak>
      <div class="header">
        <div class="brand">
          <div class="logo" data-brand="headerLogo">{{ brand.headerLogo }}</div>
          <div>
            <div class="brand-title" data-brand="productName">{{ brand.productName }}</div>
              <div class="muted" data-brand="projectName">{{ brand.projectName }}</div>
            </div>
          </div>

        <div style="display:flex; align-items:center; gap: 12px;">
          <a-button type="primary" :loading="demoRunning" :disabled="!me" @click="runDemo">一键问数</a-button>
          <a-button type="default" :disabled="busy || !me" @click="confirmResetDb">重置数据</a-button>
          <template v-if="me">
            <a-tag color="geekblue">{{ me.username }}</a-tag>
            <a-tag>{{ me.role }}</a-tag>
            <a-button v-if="me.role === 'admin'" type="default" @click="openAccountManager">账号管理</a-button>
            <a-button v-if="me.role === 'admin'" type="default" @click="openBrandEditor">编辑内容</a-button>
            <a-button type="default" @click="showLogin=true">切换账号</a-button>
            <a-button type="text" @click="logout">退出</a-button>
          </template>
          <template v-else>
            <a-button type="primary" @click="showLogin=true">登录</a-button>
          </template>
	        </div>
      </div>

      <div class="main">
        <div class="card chat">
          <div class="card-hd">
            <div style="display:flex; flex-direction:column; gap: 2px;">
              <span style="font-weight:800;">AI 智能问数</span>
              <span class="muted">SQL可见/可编辑 · 表格+图表同屏 · 支持上屏</span>
            </div>
            <div class="chat-toolbar">
              <div class="chat-toolbar-group">
                <span class="muted">数据源</span>
                <a-select
                  v-model:value="selectedDataSources"
                  mode="multiple"
                  :options="dataSourceOptions"
                  size="small"
                  style="min-width: 220px;"
                  placeholder="选择数据源"
                  :disabled="!me"
                />
              </div>
              <div class="chat-toolbar-group">
                <span class="muted">对话</span>
                <a-select
                  v-model:value="activeConversationId"
                  :options="conversationOptions"
                  size="small"
                  style="min-width: 180px;"
                />
              </div>
              <a-button size="small" type="default" @click="newConversation" :disabled="busy || !me">新对话</a-button>
              <a-button size="small" @click="clearConversation" :disabled="busy || !me">清空</a-button>
              <a-button size="small" type="link" @click="openDataSources">管理数据源</a-button>
            </div>
          </div>

          <div class="chat-log" ref="chatLog">
            <div v-for="(m, idx) in messages" :key="m.id || idx" class="msg" :class="m.role">
              <div class="avatar" :class="m.role">{{ m.role === 'ai' ? 'AI' : '我' }}</div>
              <div class="bubble" :class="{ wide: !!m.result }">
                <div v-if="m.content">{{ m.content }}</div>
                <div v-if="m.result" class="result-wrap">
                  <div class="result-head">
                    <div style="font-weight:800;">查询结果</div>
                    <div class="result-meta">
                      <a-tag color="geekblue">{{ resultCount(m.result) }} 条</a-tag>
                      <a-tag v-if="displayChartType(m)" color="purple">{{ displayChartType(m) }}</a-tag>
                      <a-button type="link" size="small" @click="toggleExpand(m)">{{ m.expanded ? '收起' : '展开' }}</a-button>
                    </div>
                  </div>

                  <div v-if="m.expanded" class="result-grid">
                    <div class="panel">
                      <div v-if="m.result && m.result.sql_explain" style="margin-bottom:10px;">
                        <div style="font-weight:650; margin-bottom:6px;">SQL 说明</div>
                        <div class="muted" style="white-space:pre-wrap;">{{ m.result.sql_explain }}</div>
                      </div>
                      <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 8px;">
                        <div style="font-weight:650;">SQL（可编辑运行）</div>
                        <div style="display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end;">
                          <a-button size="small" @click="copySql(m)" :disabled="!m.sqlDraft || !m.sqlDraft.trim()">复制SQL</a-button>
                          <a-button size="small" @click="runSql(m)" :loading="busy">运行SQL</a-button>
                          <a-button size="small" @click="pinToDashboard(m)" :disabled="!m.result.result_id">上屏</a-button>
                          <a-button size="small" @click="exportExcel(m)" :disabled="!m.result.data || m.result.data.length===0">导出Excel</a-button>
                          <a-button size="small" @click="exportPdf(m)" :disabled="!m.result.data || m.result.data.length===0">导出PDF</a-button>
                        </div>
                      </div>
                      <a-textarea v-model:value="m.sqlDraft" :auto-size="{minRows:4, maxRows:10}" class="sql-box"></a-textarea>
                      <div style="margin-top:10px;">
                        <div style="font-weight:650; margin-bottom:6px;">思考过程</div>
                        <div class="muted" style="white-space:pre-wrap;">{{ m.result.analysis }}</div>
                      </div>
                    </div>

                    <div class="panel">
                      <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px;">
                        <div style="font-weight:650;">结果表格</div>
                        <span class="muted">结果输出，支持导出/上屏</span>
                      </div>
                      <div style="margin-top:10px;">
                        <a-table
                          size="small"
                          :columns="tableColumnsFor(m.result)"
                          :data-source="tableDataFor(m.result)"
                          :pagination="{ pageSize: 8 }"
                          :scroll="{ x: 'max-content' }"
                          row-key="__idx"
                        ></a-table>
                      </div>
                    </div>

                    <div class="panel">
                      <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px;">
                        <div style="font-weight:650;">图表展示</div>
                        <div style="display:flex; align-items:center; gap: 8px;">
                          <span class="muted">类型</span>
                          <a-select
                            v-model:value="m.chartType"
                            :options="chartTypeOptions"
                            size="small"
                            style="width:140px;"
                            @change="(v) => onChartTypeChange(m, v)"
                          />
                        </div>
                      </div>
                      <div style="margin-top:10px;">
                        <div :ref="(el) => setMsgChartEl(m, el)" class="chart"></div>
                        <div
                          v-if="!hasRenderableChart(m)"
                          class="muted"
                          style="margin-top:8px;"
                        >当前数据不适合生成图表，可继续查看表格。</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div v-if="chatting" class="msg ai">
              <div class="avatar ai">AI</div>
              <div class="bubble"><span class="typing"><i></i><i></i><i></i></span></div>
            </div>
          </div>

          <div class="chat-input">
            <div v-if="examples.length" class="examples-row">
              <span class="muted">示例：</span>
              <div class="examples">
                <a-tag v-for="ex in examplePreview" :key="ex" class="ex-tag" @click="fillExample(ex)">{{ ex }}</a-tag>
              </div>
            </div>
            <div style="display:flex; gap: 10px;">
              <a-input
                v-model:value="input"
                :disabled="busy || !me"
                placeholder="例如：按月统计火警趋势，并给出分析"
                style="flex: 1;"
                @pressEnter="send"
              ></a-input>
              <a-button type="primary" :loading="busy" :disabled="!me" style="width:120px;" @click="send">发送</a-button>
            </div>
          </div>
        </div>
      </div>

      <a-modal v-model:open="showLogin" title="登录" :footer="null" :maskClosable="false">
          <a-form layout="vertical" :model="login" @finish="doLogin">
          <a-form-item label="用户名" name="username" :rules="[{ required: true, message: '请输入用户名' }]">
            <a-input v-model:value="login.username"></a-input>
          </a-form-item>
          <a-form-item label="密码" name="password" :rules="[{ required: true, message: '请输入密码' }]">
            <a-input-password v-model:value="login.password"></a-input-password>
          </a-form-item>
          <div class="muted" v-if="loginError" style="color:#dc2626; margin-bottom: 10px;">{{ loginError }}</div>
          <div style="display:flex; justify-content:flex-end; gap: 8px;">
            <a-button @click="showLogin=false">取消</a-button>
            <a-button type="primary" html-type="submit" :loading="busy">登录</a-button>
          </div>
        </a-form>
      </a-modal>

      <a-modal v-model:open="showBrandEditor" title="编辑内容" :footer="null" :maskClosable="false" width="520">
        <a-form layout="vertical">
          <a-form-item label="系统名称">
            <a-input v-model:value="brandForm.productName" />
          </a-form-item>
          <a-form-item label="项目名称">
            <a-input v-model:value="brandForm.projectName" />
          </a-form-item>
          <a-form-item label="顶部Logo">
            <a-input v-model:value="brandForm.headerLogo" />
          </a-form-item>
          <a-form-item label="侧边栏Logo">
            <a-input v-model:value="brandForm.sideLogo" />
          </a-form-item>
        </a-form>
        <div class="muted">保存后刷新页面即可同步到其它模块。</div>
        <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px;">
          <a-button @click="showBrandEditor=false">取消</a-button>
          <a-button @click="resetBrand">恢复默认</a-button>
          <a-button type="primary" @click="saveBrand">保存</a-button>
        </div>
      </a-modal>

      <a-modal v-model:open="showAccountManager" title="账号管理" :footer="null" width="720">
        <div style="font-weight:650; margin-bottom:8px;">新增账号</div>
        <div style="display:flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
          <a-input v-model:value="userForm.username" placeholder="用户名" style="width: 160px;" />
          <a-input-password v-model:value="userForm.password" placeholder="初始密码" style="width: 160px;" />
          <a-select
            v-model:value="userForm.role"
            :options="[{ label: '管理员', value: 'admin' }, { label: '普通用户', value: 'user' }]"
            style="width: 140px;"
          />
          <a-button type="primary" :loading="userFormLoading" @click="createUser">添加</a-button>
        </div>
        <a-divider />
        <template v-if="users.length">
          <a-list :data-source="users" bordered>
            <template #renderItem="{ item }">
              <a-list-item>
                <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                  <div style="display:flex; align-items:center; gap: 8px;">
                    <span style="font-weight:650;">{{ item.username }}</span>
                    <a-tag>{{ item.role }}</a-tag>
                  </div>
                  <div style="display:flex; gap: 8px;">
                    <a-button size="small" @click="openResetPassword(item)">重置密码</a-button>
                    <a-button size="small" danger @click="confirmDeleteUser(item)">删除</a-button>
                  </div>
                </div>
              </a-list-item>
            </template>
          </a-list>
        </template>
        <div v-else class="muted">暂无账号</div>
      </a-modal>

      <a-modal v-model:open="showResetPassword" title="重置密码" :footer="null" :maskClosable="false" width="420">
        <a-form layout="vertical">
          <a-form-item label="账号">
            <a-input v-model:value="resetPassword.username" disabled />
          </a-form-item>
          <a-form-item label="新密码">
            <a-input-password v-model:value="resetPassword.password" placeholder="输入新密码" />
          </a-form-item>
        </a-form>
        <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px;">
          <a-button @click="showResetPassword=false">取消</a-button>
          <a-button type="primary" @click="submitResetPassword">保存</a-button>
        </div>
      </a-modal>

      <a-modal v-model:open="showAddSource" title="新增数据源" :footer="null" :maskClosable="false">
        <a-form layout="vertical">
          <a-form-item label="数据源ID">
            <a-input v-model:value="addSource.id" placeholder="仅字母/数字/下划线" />
          </a-form-item>
          <a-form-item label="名称">
            <a-input v-model:value="addSource.name" placeholder="如：交通专题库" />
          </a-form-item>
          <a-form-item label="描述">
            <a-input v-model:value="addSource.description" placeholder="可选" />
          </a-form-item>
          <a-form-item label="数据库类型">
            <a-select v-model:value="addSource.db_type" :options="dbTypeOptions" />
          </a-form-item>
          <a-form-item label="连接地址" v-if="addSource.db_type !== 'sqlite'">
            <a-input
              v-model:value="addSource.db_url"
              placeholder="mysql+pymysql://user:pass@host:3306/db 或 postgresql+psycopg://user:pass@host:5432/db"
            />
          </a-form-item>
          <a-form-item label="数据库路径（SQLite）" v-if="addSource.db_type === 'sqlite'">
            <a-input v-model:value="addSource.db_path" placeholder="留空使用默认库 demo.db" />
          </a-form-item>
          <a-form-item label="表名（逗号分隔）">
            <a-input v-model:value="addSource.tablesText" placeholder="table_a, table_b" />
          </a-form-item>
        </a-form>
        <div class="muted">提示：SQLite 使用本机文件路径；MySQL/PG 请填写连接地址。</div>
        <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px;">
          <a-button @click="showAddSource=false">取消</a-button>
          <a-button type="primary" :loading="addSourceLoading" @click="submitAddSource">保存</a-button>
        </div>
      </a-modal>

      <a-modal v-model:open="showAddTable" title="新增表格" :footer="null" :maskClosable="false">
        <a-form layout="vertical">
          <a-form-item label="数据源ID">
            <a-input v-model:value="addTable.datasourceId" placeholder="新增或已有数据源ID" />
          </a-form-item>
          <a-form-item label="名称（新数据源可填）">
            <a-input v-model:value="addTable.datasourceName" placeholder="可选" />
          </a-form-item>
          <a-form-item label="描述（新数据源可填）">
            <a-input v-model:value="addTable.datasourceDescription" placeholder="可选" />
          </a-form-item>
          <a-form-item label="数据库路径（SQLite）">
            <a-input v-model:value="addTable.dbPath" placeholder="留空使用默认库 demo.db" />
          </a-form-item>
          <a-form-item label="表名">
            <a-input v-model:value="addTable.tableName" placeholder="例如：traffic_event" />
          </a-form-item>
          <a-form-item label="字段定义（每行 name:type）">
            <a-textarea
              v-model:value="addTable.columnsText"
              :auto-size="{minRows:4,maxRows:8}"
              placeholder="id:TEXT&#10;name:TEXT&#10;count:INTEGER"
            />
          </a-form-item>
          <a-form-item label="示例数据（JSON数组，可空）">
            <a-textarea
              v-model:value="addTable.rowsText"
              :auto-size="{minRows:3,maxRows:8}"
              placeholder='[{"id":"A1","name":"样例","count":12}]'
            />
          </a-form-item>
        </a-form>
        <div class="muted">字段类型支持：TEXT/INTEGER/REAL/NUMERIC/BLOB。</div>
        <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px;">
          <a-button @click="showAddTable=false">取消</a-button>
          <a-button type="primary" :loading="addTableLoading" @click="submitAddTable">保存</a-button>
        </div>
      </a-modal>

      <a-modal v-model:open="showUploadTable" title="上传表格" :footer="null" :maskClosable="false" width="720">
        <a-form layout="vertical">
          <a-form-item label="数据源ID">
            <a-input v-model:value="uploadTable.datasourceId" placeholder="新增或已有数据源ID" />
          </a-form-item>
          <a-form-item label="名称（新数据源可填）">
            <a-input v-model:value="uploadTable.datasourceName" placeholder="可选" />
          </a-form-item>
          <a-form-item label="描述（新数据源可填）">
            <a-input v-model:value="uploadTable.datasourceDescription" placeholder="可选" />
          </a-form-item>
          <a-form-item label="数据库路径（SQLite）">
            <a-input v-model:value="uploadTable.dbPath" placeholder="留空使用默认库 demo.db" />
          </a-form-item>
          <a-form-item label="表名">
            <a-input v-model:value="uploadTable.tableName" placeholder="例如：traffic_event" />
          </a-form-item>
          <a-form-item label="选择文件（Excel/CSV）">
            <input type="file" accept=".xlsx,.xls,.csv" @change="handleUploadFileChange" />
          </a-form-item>
          <a-form-item label="Sheet（Excel 可选）">
            <a-select
              v-model:value="uploadTable.sheetName"
              :options="uploadSheetOptions"
              :disabled="uploadSheetOptions.length<=1"
              @change="onUploadSheetChange"
              placeholder="默认第一张"
            />
          </a-form-item>
          <a-form-item label="最大导入行数">
            <a-input-number v-model:value="uploadTable.maxRows" :min="1" :max="20000" style="width:160px;" />
          </a-form-item>
        </a-form>
        <div class="muted">字段名会自动清洗为字母/数字/下划线；建议表名使用英文或下划线。</div>
        <div v-if="uploadPreviewRows.length" style="margin-top: 12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
            <div style="font-weight:650;">预览（前5行）</div>
            <a-tag>{{ uploadRows.length }} 行</a-tag>
          </div>
          <a-table
            size="small"
            :columns="uploadPreviewColumns"
            :data-source="uploadPreviewRows"
            :pagination="false"
            :scroll="{ x: 'max-content' }"
            row-key="__idx"
          ></a-table>
        </div>
        <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top: 12px;">
          <a-button @click="showUploadTable=false">取消</a-button>
          <a-button type="primary" :loading="uploadTableLoading" @click="submitUploadTable">导入</a-button>
        </div>
      </a-modal>
    </div>
    <div class="boot-loading">加载中…</div>
    </div>

    <script>
      const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

      function apiFetch(path, options = {}) {
        return fetch(new URL("api" + path, window.location.href), {
          credentials: "include",
          headers: { "Content-Type": "application/json", ...(options.headers || {}) },
          ...options,
        }).then(async (r) => {
          const text = await r.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch {}
          if (!r.ok) {
            if (r.status === 401) {
              try { window.dispatchEvent(new CustomEvent("smartask-auth-required")); } catch {}
            }
            const msg = (json && (json.detail || json.message)) || text || `HTTP ${r.status}`;
            throw new Error(msg);
          }
          return json;
        });
      }

      async function apiStream(path, payload, onEvent) {
        const res = await fetch(new URL("api" + path, window.location.href), {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json", Accept: "text/event-stream" },
          body: JSON.stringify(payload || {}),
        });
        if (!res.ok) {
          const text = await res.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch {}
          if (res.status === 401) {
            try { window.dispatchEvent(new CustomEvent("smartask-auth-required")); } catch {}
          }
          const msg = (json && (json.detail || json.message)) || text || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        if (!res.body) {
          throw new Error("浏览器不支持流式响应");
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          buffer = buffer.replace(/\r/g, "");
          let idx = buffer.indexOf("\n\n");
          while (idx >= 0) {
            const chunk = buffer.slice(0, idx);
            buffer = buffer.slice(idx + 2);
            idx = buffer.indexOf("\n\n");
            if (!chunk.trim()) continue;
            let event = "message";
            const dataLines = [];
            for (const line of chunk.split("\n")) {
              if (line.startsWith("event:")) {
                event = line.slice(6).trim();
              } else if (line.startsWith("data:")) {
                dataLines.push(line.slice(5).trimStart());
              }
            }
            const dataText = dataLines.join("\n");
            let data = null;
            try { data = dataText ? JSON.parse(dataText) : null; } catch { data = dataText; }
            if (onEvent) onEvent(event, data);
          }
        }
      }

      const BRAND_STORAGE_KEY = "smartask_brand_config_v1";
      const CHAT_STORAGE_KEY = "smartask_chat_state_v2";
      const DS_SELECTION_KEY = "smartask_selected_datasources_v1";

      function defaultBrandConfig() {
        return {
          projectName: "广东省消防救援总队数据治理（2024）项目",
          productName: "智能问数",
          headerLogo: "BI",
          sideLogo: "粤消",
        };
      }

      function loadBrandConfig() {
        try {
          const raw = localStorage.getItem(BRAND_STORAGE_KEY);
          const data = raw ? JSON.parse(raw) : null;
          return { ...defaultBrandConfig(), ...(data || {}) };
        } catch {
          return defaultBrandConfig();
        }
      }

      function saveBrandConfig(config) {
        try {
          localStorage.setItem(BRAND_STORAGE_KEY, JSON.stringify(config || {}));
        } catch {}
      }

      function applyBrandToShell(config) {
        const mapping = {
          sideLogo: config && config.sideLogo,
          projectName: config && config.projectName,
        };
        Object.entries(mapping).forEach(([key, val]) => {
          if (!val) return;
          document.querySelectorAll(`[data-brand="${key}"]`).forEach((el) => {
            el.textContent = val;
          });
        });
      }

      function loadChatState() {
        try {
          const raw = localStorage.getItem(CHAT_STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function saveChatState(state) {
        try {
          localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(state || {}));
        } catch {}
      }

      function loadDatasourceSelection() {
        try {
          const raw = localStorage.getItem(DS_SELECTION_KEY);
          const data = raw ? JSON.parse(raw) : [];
          return Array.isArray(data) ? data : [];
        } catch {
          return [];
        }
      }

      function saveDatasourceSelection(ids) {
        try {
          localStorage.setItem(DS_SELECTION_KEY, JSON.stringify(ids || []));
        } catch {}
      }

      const app = createApp({
        setup() {
          let msgSeq = 1;
          let convSeq = 1;
          const me = ref(null);
          const brand = ref(loadBrandConfig());
          const showBrandEditor = ref(false);
          const brandForm = ref({ ...brand.value });
          const showLogin = ref(false);
          const login = ref({ username: "", password: "" });
          const loginError = ref("");
          const busy = ref(false);
          const chatting = ref(false);
          const demoRunning = ref(false);

          const dataSources = ref([]);
          const selectedDataSources = ref(loadDatasourceSelection());
          const examples = ref([]);
          const metrics = ref(null);
          const metricsLoading = ref(false);

          const showAccountManager = ref(false);
          const users = ref([]);
          const userForm = ref({ username: "", password: "", role: "user" });
          const userFormLoading = ref(false);
          const showResetPassword = ref(false);
          const resetPassword = ref({ username: "", password: "" });

          const showAddSource = ref(false);
          const showAddTable = ref(false);
          const addSourceLoading = ref(false);
          const addTableLoading = ref(false);
          const addSource = ref({
            id: "",
            name: "",
            description: "",
            db_type: "sqlite",
            db_path: "",
            db_url: "",
            tablesText: "",
          });
          const addTable = ref({
            datasourceId: "",
            datasourceName: "",
            datasourceDescription: "",
            dbPath: "",
            tableName: "",
            columnsText: "id:TEXT\nname:TEXT\ncount:INTEGER",
            rowsText: "",
          });
          const showUploadTable = ref(false);
          const uploadTableLoading = ref(false);
          const uploadTable = ref({
            datasourceId: "",
            datasourceName: "",
            datasourceDescription: "",
            dbPath: "",
            tableName: "",
            sheetName: "",
            maxRows: 1000,
          });
          const uploadWorkbook = ref(null);
          const uploadSheetOptions = ref([]);
          const uploadRows = ref([]);
          const uploadColumns = ref([]);
          const uploadPreviewRows = ref([]);
          const uploadPreviewColumns = computed(() => {
            return (uploadColumns.value || []).map((c) => ({
              title: c.name,
              dataIndex: c.name,
              key: c.name,
            }));
          });
          const examplePreview = computed(() => (examples.value || []).slice(0, 6));
          const dataSourceOptions = computed(() =>
            (dataSources.value || []).map((ds) => ({ label: ds.name, value: ds.id }))
          );

          const chartTypeOptions = [
            { label: "自动", value: "auto" },
            { label: "折线", value: "line" },
            { label: "面积", value: "area" },
            { label: "柱状", value: "bar" },
            { label: "分组柱状", value: "bar_group" },
            { label: "堆叠柱状", value: "bar_stack" },
            { label: "横向条形", value: "bar_horizontal" },
            { label: "饼图", value: "pie" },
            { label: "散点", value: "scatter" },
            { label: "热力", value: "heatmap" },
          ];
          const dbTypeOptions = [
            { label: "SQLite", value: "sqlite" },
            { label: "MySQL", value: "mysql" },
            { label: "PostgreSQL", value: "postgres" },
          ];

          function newMsgId() {
            msgSeq += 1;
            return `m_${Date.now()}_${msgSeq}_${Math.random().toString(16).slice(2)}`;
          }

          function defaultMessages() {
            return [
              { id: newMsgId(), role: "ai", content: "你好，我是智能问数助手。你可以直接用自然语言提问，例如：按月统计火警趋势。" },
            ];
          }

          function newConversationId() {
            convSeq += 1;
            return `c_${Date.now()}_${convSeq}_${Math.random().toString(16).slice(2)}`;
          }

          function defaultConversation() {
            return {
              id: newConversationId(),
              title: "新对话",
              messages: defaultMessages(),
              created_at: Date.now(),
              updated_at: Date.now(),
            };
          }

          const chatState = loadChatState();
          const conversations = ref(
            (chatState && Array.isArray(chatState.conversations) && chatState.conversations.length)
              ? chatState.conversations
              : [defaultConversation()]
          );
          const activeConversationId = ref(
            (chatState && chatState.activeConversationId) || conversations.value[0].id
          );
          const activeConversation = computed(() =>
            conversations.value.find((c) => c.id === activeConversationId.value) || conversations.value[0]
          );
          const messages = computed({
            get() {
              return activeConversation.value ? activeConversation.value.messages : [];
            },
            set(val) {
              if (activeConversation.value) activeConversation.value.messages = val;
            },
          });
          const conversationOptions = computed(() =>
            (conversations.value || []).map((c, idx) => ({
              label: c.title || `对话${idx + 1}`,
              value: c.id,
            }))
          );
          const input = ref("");
          const didAutoDemo = ref(false);

          function touchConversation(conv) {
            if (!conv) return;
            conv.updated_at = Date.now();
          }

          function ensureConversationTitle(question) {
            const conv = activeConversation.value;
            if (!conv) return;
            const title = (conv.title || "").trim();
            if (!title || title === "新对话") {
              conv.title = question.length > 16 ? question.slice(0, 16) + "…" : question;
            }
          }

          function pushMessage(msg) {
            const conv = activeConversation.value;
            if (!conv) return;
            conv.messages.push(msg);
            touchConversation(conv);
          }

          function clearConversation() {
            const conv = activeConversation.value;
            if (!conv) return;
            conv.messages = defaultMessages();
            input.value = "";
            chatting.value = false;
            didAutoDemo.value = true;
            disposeAllCharts();
            scrollBottom();
          }

          function newConversation() {
            const conv = defaultConversation();
            conversations.value.unshift(conv);
            activeConversationId.value = conv.id;
            scrollBottom();
          }

          const chatLog = ref(null);
          const chartEls = new Map();
          const charts = new Map();

          function resultCount(r) {
            if (!r) return 0;
            const c = r.count ?? (r.data ? r.data.length : 0);
            return Number.isFinite(c) ? c : (r.data ? r.data.length : 0);
          }

          function hasChart(r) {
            const t = r && r.chart && r.chart.type;
            return !!(t && t !== "table");
          }

          function pickDefaultView(r) {
            return hasChart(r) ? "图表" : "表格";
          }

          function assistantSummary(r) {
            const cnt = resultCount(r);
            if (!cnt) return "没有查到符合条件的数据。你可以调整时间范围或单位范围再试试。";
            return `查询到 ${cnt} 条记录，已生成${hasChart(r) ? "表格与图表" : "表格"}，可在下方查看。`;
          }

          function analyzeColumns(rows) {
            if (!rows.length) return { cols: [], numericCols: [], textCols: [] };
            const cols = Object.keys(rows[0]);
            const numericCols = cols.filter((c) =>
              rows.some((r) => typeof r[c] === "number" && Number.isFinite(r[c]))
            );
            const textCols = cols.filter((c) => !numericCols.includes(c));
            return { cols, numericCols, textCols };
          }

          function buildChartConfig(type, rows, baseCfg) {
            if (!rows.length) return null;
            const { cols, numericCols, textCols } = analyzeColumns(rows);
            const title = (baseCfg && baseCfg.title) || "查询结果";
            const cfg = { type, title };

            if (type === "pie") {
              const nameField = (baseCfg && baseCfg.nameField) || textCols[0] || cols[0];
              const valueField = (baseCfg && baseCfg.valueField) || numericCols[0] || cols[1];
              if (!nameField || !valueField) return null;
              return { ...cfg, nameField, valueField };
            }

            if (type === "heatmap") {
              const xField = (baseCfg && baseCfg.xField) || cols[0];
              const yField = (baseCfg && baseCfg.yField) || cols[1];
              const valueField = (baseCfg && baseCfg.valueField) || numericCols[0] || cols[2];
              if (!xField || !yField || !valueField) return null;
              return { ...cfg, xField, yField, valueField };
            }

            if (type === "scatter") {
              const xField = (baseCfg && baseCfg.xField) || numericCols[0];
              const yField = (baseCfg && baseCfg.yField) || numericCols[1];
              if (!xField || !yField) return null;
              return { ...cfg, xField, yField };
            }

            if (type === "bar_group" || type === "bar_stack") {
              if (baseCfg && baseCfg.seriesField) {
                return { ...cfg, xField: baseCfg.xField, seriesField: baseCfg.seriesField, valueField: baseCfg.valueField };
              }
              if (baseCfg && Array.isArray(baseCfg.yFields) && baseCfg.yFields.length) {
                return { ...cfg, xField: baseCfg.xField, yFields: baseCfg.yFields };
              }
              if (textCols.length >= 2 && numericCols.length) {
                return { ...cfg, xField: textCols[0], seriesField: textCols[1], valueField: numericCols[0] };
              }
              if (textCols.length >= 1 && numericCols.length >= 2) {
                return { ...cfg, xField: textCols[0], yFields: numericCols.slice(0, 3) };
              }
              return null;
            }

            if (["line", "bar", "area", "bar_horizontal"].includes(type)) {
              const xField = (baseCfg && baseCfg.xField) || textCols[0] || cols[0];
              if (baseCfg && Array.isArray(baseCfg.yFields) && baseCfg.yFields.length) {
                return { ...cfg, xField, yFields: baseCfg.yFields };
              }
              if (numericCols.length >= 2 && (type === "line" || type === "area")) {
                return { ...cfg, xField, yFields: numericCols.slice(0, 3) };
              }
              const yField = (baseCfg && baseCfg.yField) || numericCols[0] || cols[1];
              if (!xField || !yField) return null;
              return { ...cfg, xField, yField };
            }

            return baseCfg || null;
          }

          function resolveChartConfig(m) {
            if (!m || !m.result) return null;
            const baseCfg = m.result.chart || null;
            const rows = m.result.data || [];
            const target = (m.chartType || "auto").trim();
            if (!target || target === "auto") return baseCfg;
            return buildChartConfig(target, rows, baseCfg);
          }

          function displayChartType(m) {
            const cfg = resolveChartConfig(m);
            if (!cfg || !cfg.type || cfg.type === "table") return "";
            const labelMap = {
              line: "折线",
              area: "面积",
              bar: "柱状",
              bar_group: "分组柱状",
              bar_stack: "堆叠柱状",
              bar_horizontal: "横向条形",
              pie: "饼图",
              heatmap: "热力",
              scatter: "散点",
            };
            return labelMap[cfg.type] || cfg.type;
          }

          function hasRenderableChart(m) {
            const cfg = resolveChartConfig(m);
            return !!(cfg && cfg.type && cfg.type !== "table");
          }

          function parseTableList(text) {
            return String(text || "")
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean);
          }

          function parseColumns(text) {
            const lines = String(text || "")
              .split("\n")
              .map((s) => s.trim())
              .filter(Boolean);
            return lines.map((line) => {
              const idx = line.indexOf(":");
              if (idx === -1) return { name: line, type: "TEXT" };
              return { name: line.slice(0, idx).trim(), type: line.slice(idx + 1).trim() || "TEXT" };
            });
          }

          async function submitAddSource() {
            if (addSourceLoading.value) return;
            const id = (addSource.value.id || "").trim();
            const name = (addSource.value.name || "").trim();
            const description = (addSource.value.description || "").trim();
            const dbType = String(addSource.value.db_type || "sqlite").trim().toLowerCase();
            const dbPath = (addSource.value.db_path || "").trim();
            const dbUrl = (addSource.value.db_url || "").trim();
            const tables = parseTableList(addSource.value.tablesText);

            if (!id) {
              antd.message.error("请填写数据源ID");
              return;
            }
            if (!tables.length) {
              antd.message.error("请至少填写一张表");
              return;
            }
            if (dbType !== "sqlite" && !dbUrl) {
              antd.message.error("请填写数据库连接地址");
              return;
            }

            const payload = {
              id,
              name,
              description,
              db_type: dbType || "sqlite",
              tables,
            };
            if (dbType === "sqlite" && dbPath) payload.db_path = dbPath;
            if (dbType !== "sqlite") payload.db_url = dbUrl;

            addSourceLoading.value = true;
            try {
              await apiFetch("/datasources", { method: "POST", body: JSON.stringify(payload) });
              antd.message.success("已新增数据源");
              showAddSource.value = false;
              addSource.value = {
                id: "",
                name: "",
                description: "",
                db_type: "sqlite",
                db_path: "",
                db_url: "",
                tablesText: "",
              };
              if (!selectedDataSources.value.includes(id)) {
                selectedDataSources.value.push(id);
              }
              await refreshDataSources();
            } catch (e) {
              antd.message.error(e.message || "新增失败");
            } finally {
              addSourceLoading.value = false;
            }
          }

          async function submitAddTable() {
            if (addTableLoading.value) return;
            const id = (addTable.value.datasourceId || "").trim();
            const name = (addTable.value.datasourceName || "").trim();
            const description = (addTable.value.datasourceDescription || "").trim();
            const dbPath = (addTable.value.dbPath || "").trim();
            const tableName = (addTable.value.tableName || "").trim();
            const columns = parseColumns(addTable.value.columnsText || "");

            if (!id) {
              antd.message.error("请填写数据源ID");
              return;
            }
            if (!tableName) {
              antd.message.error("请填写表名");
              return;
            }
            if (!columns.length) {
              antd.message.error("请填写字段定义");
              return;
            }

            let rows = [];
            const rowsRaw = (addTable.value.rowsText || "").trim();
            if (rowsRaw) {
              try {
                rows = JSON.parse(rowsRaw);
                if (!Array.isArray(rows)) {
                  throw new Error("示例数据必须是数组");
                }
              } catch (e) {
                antd.message.error(e.message || "示例数据 JSON 格式错误");
                return;
              }
            }

            const payload = {
              id,
              name,
              description,
              tables: [tableName],
              create_table: { name: tableName, columns, rows },
            };
            if (dbPath) payload.db_path = dbPath;

            addTableLoading.value = true;
            try {
              await apiFetch("/datasources", { method: "POST", body: JSON.stringify(payload) });
              antd.message.success("已新增表格");
              showAddTable.value = false;
              addTable.value = {
                datasourceId: "",
                datasourceName: "",
                datasourceDescription: "",
                dbPath: "",
                tableName: "",
                columnsText: "id:TEXT\nname:TEXT\ncount:INTEGER",
                rowsText: "",
              };
              if (!selectedDataSources.value.includes(id)) {
                selectedDataSources.value.push(id);
              }
              await refreshDataSources();
            } catch (e) {
              antd.message.error(e.message || "新增失败");
            } finally {
              addTableLoading.value = false;
            }
          }

          function sanitizeIdentifier(name, fallback) {
            let cleaned = String(name || "").trim().replace(/[^A-Za-z0-9_]/g, "_");
            if (!cleaned) cleaned = fallback;
            if (/^[0-9]/.test(cleaned)) cleaned = `col_${cleaned}`;
            return cleaned;
          }

          function inferColumnType(values) {
            let hasFloat = false;
            let hasInt = false;
            let hasOther = false;
            for (const v of values) {
              if (v === null || v === undefined || v === "") continue;
              if (typeof v === "number") {
                if (Number.isInteger(v)) hasInt = true;
                else hasFloat = true;
                continue;
              }
              if (typeof v === "string") {
                const t = v.trim();
                if (!t) continue;
                if (/^-?\d+(\.\d+)?$/.test(t)) {
                  const num = Number(t);
                  if (Number.isInteger(num)) hasInt = true;
                  else hasFloat = true;
                } else {
                  hasOther = true;
                }
                continue;
              }
              hasOther = true;
            }
            if (hasOther) return "TEXT";
            if (hasFloat) return "REAL";
            if (hasInt) return "INTEGER";
            return "TEXT";
          }

          function normalizeValue(value, type) {
            if (value === null || value === undefined || value === "") return null;
            if (type === "INTEGER") {
              const v = typeof value === "number" ? value : Number(String(value).trim());
              return Number.isFinite(v) ? Math.trunc(v) : null;
            }
            if (type === "REAL") {
              const v = typeof value === "number" ? value : Number(String(value).trim());
              return Number.isFinite(v) ? v : null;
            }
            return value;
          }

          function buildUploadRows(rows, maxRows) {
            const sliced = rows.slice(0, maxRows);
            const rawCols = Object.keys(sliced[0] || {});
            const colMap = {};
            const used = new Set();
            rawCols.forEach((col, idx) => {
              let safe = sanitizeIdentifier(col, `col_${idx + 1}`);
              let base = safe;
              let i = 2;
              while (used.has(safe)) {
                safe = `${base}_${i}`;
                i += 1;
              }
              used.add(safe);
              colMap[col] = safe;
            });

            const normalizedRows = sliced.map((row) => {
              const out = {};
              for (const [orig, safe] of Object.entries(colMap)) {
                out[safe] = row[orig];
              }
              return out;
            });

            const columns = Object.values(colMap).map((name) => ({ name, type: "TEXT" }));
            for (const col of columns) {
              const values = normalizedRows.map((r) => r[col.name]);
              col.type = inferColumnType(values);
            }
            for (const row of normalizedRows) {
              for (const col of columns) {
                row[col.name] = normalizeValue(row[col.name], col.type);
              }
            }
            return { columns, rows: normalizedRows };
          }

          async function parseUploadSheet() {
            const wb = uploadWorkbook.value;
            if (!wb) return;
            const sheetName = uploadTable.value.sheetName || wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            if (!ws) return;

            const rows = XLSX.utils.sheet_to_json(ws, { defval: null, raw: true });
            if (!rows.length) {
              uploadRows.value = [];
              uploadColumns.value = [];
              uploadPreviewRows.value = [];
              return;
            }

            const maxRows = Math.max(1, parseInt(uploadTable.value.maxRows || 1000, 10));
            const result = buildUploadRows(rows, maxRows);
            uploadRows.value = result.rows.map((r, idx) => ({ __idx: idx, ...r }));
            uploadColumns.value = result.columns;
            uploadPreviewRows.value = uploadRows.value.slice(0, 5);
          }

          async function handleUploadFileChange(event) {
            const file = event && event.target && event.target.files ? event.target.files[0] : null;
            if (!file) return;
            try {
              const buf = await file.arrayBuffer();
              const wb = XLSX.read(buf, { type: "array" });
              uploadWorkbook.value = wb;
              uploadSheetOptions.value = (wb.SheetNames || []).map((n) => ({ label: n, value: n }));
              uploadTable.value.sheetName = (wb.SheetNames && wb.SheetNames[0]) || "";
              await parseUploadSheet();
            } catch (e) {
              antd.message.error(e.message || "读取文件失败");
            }
          }

          async function onUploadSheetChange() {
            await parseUploadSheet();
          }

          async function submitUploadTable() {
            if (uploadTableLoading.value) return;
            const id = (uploadTable.value.datasourceId || "").trim();
            const name = (uploadTable.value.datasourceName || "").trim();
            const description = (uploadTable.value.datasourceDescription || "").trim();
            const dbPath = (uploadTable.value.dbPath || "").trim();
            const tableName = (uploadTable.value.tableName || "").trim();

            if (!id) {
              antd.message.error("请填写数据源ID");
              return;
            }
            if (!tableName) {
              antd.message.error("请填写表名");
              return;
            }
            if (!uploadRows.value.length || !uploadColumns.value.length) {
              antd.message.error("请先选择文件并解析");
              return;
            }

            const payload = {
              id,
              name,
              description,
              tables: [tableName],
              create_table: {
                name: tableName,
                columns: uploadColumns.value,
                rows: uploadRows.value.map(({ __idx, ...rest }) => rest),
              },
            };
            if (dbPath) payload.db_path = dbPath;

            uploadTableLoading.value = true;
            try {
              await apiFetch("/datasources", { method: "POST", body: JSON.stringify(payload) });
              antd.message.success("表格已导入");
              showUploadTable.value = false;
              uploadTable.value = {
                datasourceId: "",
                datasourceName: "",
                datasourceDescription: "",
                dbPath: "",
                tableName: "",
                sheetName: "",
                maxRows: 1000,
              };
              uploadWorkbook.value = null;
              uploadSheetOptions.value = [];
              uploadRows.value = [];
              uploadColumns.value = [];
              uploadPreviewRows.value = [];
              if (!selectedDataSources.value.includes(id)) {
                selectedDataSources.value.push(id);
              }
              await refreshDataSources();
            } catch (e) {
              antd.message.error(e.message || "导入失败");
            } finally {
              uploadTableLoading.value = false;
            }
          }

          function tableDataFor(r) {
            const rows = (r && r.data) || [];
            return rows.map((row, i) => ({ __idx: i, ...row }));
          }

          function tableColumnsFor(r) {
            const rows = (r && r.data) || [];
            if (!rows.length) return [];
            return Object.keys(rows[0]).map((k) => ({ title: k, dataIndex: k, key: k }));
          }

          function scrollBottom() {
            nextTick(() => {
              if (!chatLog.value) return;
              chatLog.value.scrollTop = chatLog.value.scrollHeight;
            });
          }

          function disposeMsgChart(msgId) {
            const inst = charts.get(msgId);
            if (inst) {
              try { inst.dispose(); } catch {}
            }
            charts.delete(msgId);
            chartEls.delete(msgId);
          }

          function disposeAllCharts() {
            for (const id of Array.from(charts.keys())) disposeMsgChart(id);
            chartEls.clear();
          }

          function resetChat() {
            clearConversation();
          }

          async function refreshDataSources() {
            const res = await apiFetch("/datasources");
            dataSources.value = res.data || [];
            const preferred = selectedDataSources.value.length ? selectedDataSources.value : loadDatasourceSelection();
            const valid = preferred.filter((id) => dataSources.value.some((d) => d.id === id));
            selectedDataSources.value = valid.length ? valid : dataSources.value.map((d) => d.id);
          }

          async function refreshExamples() {
            const res = await apiFetch("/examples");
            examples.value = res.examples || [];
          }

          async function refreshMetrics() {
            if (!me.value) return;
            metricsLoading.value = true;
            try {
              const res = await apiFetch("/metrics");
              metrics.value = res.data || null;
            } catch (e) {
              metrics.value = null;
            } finally {
              metricsLoading.value = false;
            }
          }

          async function refreshMe() {
            try {
              const res = await apiFetch("/auth/me");
              me.value = res.user;
            } catch (e) {
              me.value = null;
            }
          }

          async function doLogin() {
            busy.value = true;
            loginError.value = "";
            try {
              await apiFetch("/auth/login", { method: "POST", body: JSON.stringify(login.value) });
              showLogin.value = false;
              await refreshMe();
              await refreshDataSources();
              await refreshExamples();
              await runAutoDemo();
            } catch (e) {
              loginError.value = e.message || "登录失败";
            } finally {
              busy.value = false;
            }
          }

	          async function logout() {
	            await apiFetch("/auth/logout", { method: "POST" });
	            me.value = null;
	            showLogin.value = true;
	          }

          function openDataSources() {
            window.location.href = "/datasources";
          }

          function openBrandEditor() {
            brandForm.value = { ...brand.value };
            showBrandEditor.value = true;
          }

          function saveBrand() {
            brand.value = { ...brandForm.value };
            saveBrandConfig(brand.value);
            applyBrandToShell(brand.value);
            showBrandEditor.value = false;
          }

          function resetBrand() {
            brandForm.value = { ...defaultBrandConfig() };
          }

          async function refreshUsers() {
            const res = await apiFetch("/auth/users");
            users.value = res.data || [];
          }

          async function createUser() {
            if (userFormLoading.value) return;
            const username = (userForm.value.username || "").trim();
            const password = (userForm.value.password || "").trim();
            if (!username || !password) {
              antd.message.error("请填写用户名和密码");
              return;
            }
            userFormLoading.value = true;
            try {
              await apiFetch("/auth/users", { method: "POST", body: JSON.stringify(userForm.value) });
              userForm.value = { username: "", password: "", role: "user" };
              await refreshUsers();
              antd.message.success("账号已创建");
            } catch (e) {
              antd.message.error(e.message || "创建失败");
            } finally {
              userFormLoading.value = false;
            }
          }

          function openAccountManager() {
            showAccountManager.value = true;
            refreshUsers().catch((e) => {
              antd.message.error(e.message || "加载账号失败");
            });
          }

          function confirmDeleteUser(user) {
            if (!user || !user.username) return;
            try {
              antd.Modal.confirm({
                title: "确认删除账号？",
                content: `将删除账号 ${user.username}，此操作不可恢复。`,
                okText: "删除",
                okType: "danger",
                cancelText: "取消",
                onOk: async () => {
                  try {
                    await apiFetch(`/auth/users/${encodeURIComponent(user.username)}`, { method: "DELETE" });
                    await refreshUsers();
                    antd.message.success("账号已删除");
                  } catch (e) {
                    antd.message.error(e.message || "删除失败");
                  }
                },
              });
            } catch {}
          }

          function openResetPassword(user) {
            if (!user || !user.username) return;
            resetPassword.value = { username: user.username, password: "" };
            showResetPassword.value = true;
          }

          async function submitResetPassword() {
            const username = resetPassword.value.username;
            const password = (resetPassword.value.password || "").trim();
            if (!password) {
              antd.message.error("请输入新密码");
              return;
            }
            try {
              await apiFetch(`/auth/users/${encodeURIComponent(username)}`, {
                method: "PUT",
                body: JSON.stringify({ password }),
              });
              showResetPassword.value = false;
              resetPassword.value = { username: "", password: "" };
              await refreshUsers();
              antd.message.success("密码已更新");
            } catch (e) {
              antd.message.error(e.message || "更新失败");
            }
          }

          function fillExample(ex) {
            input.value = ex;
          }

          function createAiResultMessage(content, result) {
            return {
              id: newMsgId(),
              role: "ai",
              content,
              result,
              sqlDraft: (result && result.sql) || "",
              viewMode: pickDefaultView(result),
              chartType: "auto",
              expanded: true,
            };
          }

          function ensureResult(m) {
            if (!m) return null;
            if (!m.result) {
              m.result = {
                success: true,
                sql: "",
                sql_explain: "",
                data: [],
                analysis: "",
                chart: null,
                count: 0,
                truncated: false,
                max_rows: 0,
              };
              m.sqlDraft = "";
              m.viewMode = pickDefaultView(m.result);
              m.chartType = "auto";
              m.expanded = true;
            }
            return m.result;
          }

          function toggleExpand(m) {
            if (!m) return;
            m.expanded = !m.expanded;
          }

          function onMsgViewModeChange(m, v) {
            if (!m) return;
            if (typeof v === "string") m.viewMode = v;
            if (m.expanded) scheduleRenderMsgChart(m);
          }

          function onChartTypeChange(m, v) {
            if (!m) return;
            if (typeof v === "string") m.chartType = v;
            if (m.expanded) scheduleRenderMsgChart(m);
          }

          function setMsgChartEl(m, el) {
            if (!m || !m.id) return;
            const msgId = m.id;
            if (!el) {
              disposeMsgChart(msgId);
              return;
            }
            chartEls.set(msgId, el);
            if (m.expanded) scheduleRenderMsgChart(m);
          }

          function scheduleRenderMsgChart(m) {
            if (!m) return;
            nextTick(() => {
              renderMsgChart(m);
              setTimeout(() => {
                renderMsgChart(m);
                const inst = charts.get(m.id);
                if (inst) {
                  try { inst.resize(); } catch {}
                }
              }, 80);
            });
          }

          function renderMsgChart(m) {
            if (!m || !m.id || !m.result) return;
            if (!m.expanded) return;
            const msgId = m.id;
            const el = chartEls.get(msgId);
            if (!el) return;

            if (!hasChart(m.result) || !m.result.data || !m.result.data.length) {
              const inst0 = charts.get(msgId);
              if (inst0) {
                try { inst0.clear(); } catch {}
              }
              return;
            }

            let inst = charts.get(msgId);
            if (!inst) {
              inst = echarts.init(el);
              charts.set(msgId, inst);
            }

            const r = m.result;
            const rows = (r && r.data) || [];
            const cfg = resolveChartConfig(m);
            const type = (cfg && cfg.type) || "table";

            if (!cfg || !rows.length || type === "table") {
              try { inst.clear(); } catch {}
              return;
            }

            const text = "#0f172a";
            const muted = "#475569";
            const gridLine = "rgba(15, 23, 42, 0.10)";
            const axisLine = "rgba(15, 23, 42, 0.22)";

            const option = {
              title: { text: cfg.title || "", left: "center", textStyle: { color: text, fontWeight: 900 } },
              tooltip: {},
              grid: { left: 44, right: 22, top: 64, bottom: 44 },
              textStyle: { color: muted },
            };

            if (["line", "bar", "area", "bar_group", "bar_stack", "bar_horizontal"].includes(type)) {
              const xField = cfg.xField;
              const yField = cfg.yField;
              const yFields = cfg.yFields;
              const seriesField = cfg.seriesField;
              const valueField = cfg.valueField || yField;
              const baseType = type === "area" ? "line" : "bar";
              const isLine = type === "line" || type === "area";
              const isHorizontal = type === "bar_horizontal";
              const stackKey = type === "bar_stack" ? "total" : undefined;

              let categories = rows.map((r) => r[xField]);
              let series = [];
              if (seriesField) {
                const seriesNames = Array.from(new Set(rows.map((r) => r[seriesField])));
                const categoryNames = Array.from(new Set(rows.map((r) => r[xField])));
                const lookup = new Map();
                for (const row of rows) {
                  lookup.set(`${row[seriesField]}||${row[xField]}`, row[valueField]);
                }
                categories = categoryNames;
                series = seriesNames.map((name) => ({
                  name,
                  type: isLine ? "line" : "bar",
                  stack: stackKey,
                  smooth: isLine,
                  areaStyle: type === "area" ? { opacity: 0.12 } : undefined,
                  data: categoryNames.map((cat) => lookup.get(`${name}||${cat}`) ?? 0),
                }));
              } else if (Array.isArray(yFields) && yFields.length) {
                series = yFields.map((field) => ({
                  name: field,
                  type: isLine ? "line" : "bar",
                  stack: stackKey,
                  smooth: isLine,
                  areaStyle: type === "area" ? { opacity: 0.12 } : undefined,
                  data: rows.map((r) => r[field]),
                }));
              } else {
                series = [{
                  type: isLine ? "line" : "bar",
                  data: rows.map((r) => r[valueField]),
                  smooth: isLine,
                  areaStyle: type === "area" ? { opacity: 0.12 } : undefined,
                }];
              }

              option.tooltip = { trigger: "axis" };
              if (isHorizontal) {
                option.xAxis = { type: "value", axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } }, splitLine: { lineStyle: { color: gridLine } } };
                option.yAxis = { type: "category", data: categories, axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } } };
              } else {
                option.xAxis = { type: "category", data: categories, axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } } };
                option.yAxis = { type: "value", axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } }, splitLine: { lineStyle: { color: gridLine } } };
              }
              option.series = series;
            } else if (type === "pie") {
              const nameField = cfg.nameField;
              const valueField = cfg.valueField;
              option.tooltip = { trigger: "item" };
              option.series = [{
                type: "pie",
                radius: "72%",
                label: { color: text },
                data: rows.map((r) => ({ name: r[nameField], value: r[valueField] })),
              }];
              option.grid = undefined;
            } else if (type === "heatmap") {
              const xField = cfg.xField;
              const yField = cfg.yField;
              const valueField = cfg.valueField;
              const xs = Array.from(new Set(rows.map((r) => r[xField])));
              const ys = Array.from(new Set(rows.map((r) => r[yField])));
              const data = rows.map((r) => [xs.indexOf(r[xField]), ys.indexOf(r[yField]), r[valueField]]);
              option.tooltip = { position: "top" };
              option.xAxis = { type: "category", data: xs, axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } } };
              option.yAxis = { type: "category", data: ys, axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } } };
              option.visualMap = { min: 0, max: Math.max(...rows.map((r) => r[valueField] || 0)), calculable: true, orient: "horizontal", left: "center", bottom: 0, textStyle: { color: muted } };
              option.series = [{ type: "heatmap", data }];
              option.grid.bottom = 74;
            } else if (type === "scatter") {
              const xField = cfg.xField;
              const yField = cfg.yField;
              option.tooltip = { trigger: "item" };
              option.xAxis = { type: "value", axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } }, splitLine: { lineStyle: { color: gridLine } } };
              option.yAxis = { type: "value", axisLabel: { color: muted }, axisLine: { lineStyle: { color: axisLine } }, splitLine: { lineStyle: { color: gridLine } } };
              option.series = [{
                type: "scatter",
                data: rows.map((r) => [r[xField], r[yField]]),
              }];
            }

            inst.setOption(option, true);
            try { inst.resize(); } catch {}

            // 图表联动：点击下钻
            inst.off("click");
            inst.on("click", async (params) => {
              const r0 = m.result;
              const cfg0 = resolveChartConfig(m);
              if (busy.value || !r0 || !r0.result_id || !cfg0) return;

              let field = null;
              let value = null;
              if ((cfg0.type || "") === "pie") {
                field = cfg0.nameField;
                value = params && params.name;
              } else if (["line", "area", "bar", "bar_group", "bar_stack", "bar_horizontal"].includes(cfg0.type || "")) {
                field = cfg0.xField;
                value = params && params.name;
              } else {
                return;
              }
              if (!field || value === undefined || value === null) return;

              busy.value = true;
              try {
                const res = await apiFetch("/drilldown", {
                  method: "POST",
                  body: JSON.stringify({
                    result_id: r0.result_id,
                    field,
                    value: String(value),
                    datasource_ids: selectedDataSources.value,
                  }),
                });
                pushMessage(createAiResultMessage(`已联动下钻：${field} = ${value}`, res));
                scrollBottom();
              } catch (e) {
                antd.message.error(e.message || "下钻失败");
              } finally {
                busy.value = false;
              }
            });
          }

          async function ask(q) {
            const question = (q || "").trim();
            if (!question) return;

            pushMessage({ id: newMsgId(), role: "user", content: question });
            ensureConversationTitle(question);
            scrollBottom();

            busy.value = true;
            chatting.value = true;
            const history = messages.value
              .slice(-12)
              .map((m) => ({ role: m.role === "ai" ? "assistant" : "user", content: m.content }));
            const aiMsg = {
              id: newMsgId(),
              role: "ai",
              content: "",
              result: null,
              sqlDraft: "",
              viewMode: "表格",
              chartType: "auto",
              expanded: true,
            };
            pushMessage(aiMsg);
            scrollBottom();
            try {
              await apiStream(
                "/chat/stream",
                {
                  question,
                  datasource_ids: selectedDataSources.value,
                  history,
                },
                (event, data) => {
                  if (event === "chat") {
                    aiMsg.content = (data && data.reply) || "";
                  } else if (event === "sql_explain_delta") {
                    const r = ensureResult(aiMsg);
                    const delta = (data && data.delta) || "";
                    r.sql_explain = (r.sql_explain || "") + delta;
                  } else if (event === "analysis_delta") {
                    const r = ensureResult(aiMsg);
                    const delta = (data && data.delta) || "";
                    r.analysis = (r.analysis || "") + delta;
                  } else if (event === "sql_delta") {
                    const r = ensureResult(aiMsg);
                    const delta = (data && data.delta) || "";
                    r.sql = (r.sql || "") + delta;
                    aiMsg.sqlDraft = r.sql || aiMsg.sqlDraft;
                  } else if (event === "sql") {
                    const r = ensureResult(aiMsg);
                    r.sql = (data && data.sql) || "";
                    aiMsg.sqlDraft = r.sql || aiMsg.sqlDraft;
                  } else if (event === "sql_explain") {
                    const r = ensureResult(aiMsg);
                    r.sql_explain = (data && data.sql_explain) || "";
                  } else if (event === "analysis") {
                    const r = ensureResult(aiMsg);
                    r.analysis = (data && data.analysis) || "";
                  } else if (event === "result") {
                    const r = (data && data.result) || {};
                    if (aiMsg.result && aiMsg.result.sql_explain && !r.sql_explain) {
                      r.sql_explain = aiMsg.result.sql_explain;
                    }
                    if (aiMsg.result && aiMsg.result.analysis && !r.analysis) {
                      r.analysis = aiMsg.result.analysis;
                    }
                    aiMsg.result = r;
                    aiMsg.sqlDraft = r.sql || aiMsg.sqlDraft;
                    aiMsg.viewMode = pickDefaultView(r);
                    if (aiMsg.expanded) scheduleRenderMsgChart(aiMsg);
                  } else if (event === "error") {
                    const msg = (data && data.error) || "查询失败";
                    aiMsg.content = `查询失败：${msg}`;
                  } else if (event === "done") {
                    chatting.value = false;
                    busy.value = false;
                  }
                  scrollBottom();
                }
              );
            } catch (e) {
              aiMsg.content = `查询失败：${e.message || e}`;
              scrollBottom();
            } finally {
              chatting.value = false;
              busy.value = false;
            }
          }

          async function send() {
            const q = input.value.trim();
            if (!q) return;
            if (!me.value) {
              showLogin.value = true;
              return;
            }
            input.value = "";
            await ask(q);
          }

          async function runDemo() {
            if (demoRunning.value) return;
            if (!me.value) {
              showLogin.value = true;
              return;
            }
            demoRunning.value = true;
            try {
              newConversation();
              if (activeConversation.value) activeConversation.value.title = "演示对话";
              await ask("查询最近7天的火警记录（含单位、地点、类型、处理状态）");
              await ask("按单位统计近7天火警数量");
              await ask("筛选今天未处理的火警明细");
              await ask("近7天火警处理状态占比");
              await ask("按月统计火警趋势");
              await ask("各站点人员数量与装备库存对比（多源联动）");
              try { antd.message.success("问数完成：SQL、表格与图表同屏展示，可导出或上屏"); } catch {}
            } finally {
              demoRunning.value = false;
            }
          }

          function confirmResetDb() {
            try {
              antd.Modal.confirm({
                title: "确认重置数据？",
                content: "将重建本地SQLite库（警情/人员/装备/监督检查）。适合需要时一键恢复初始数据。",
                okText: "重置",
                cancelText: "取消",
                onOk: resetDb,
              });
            } catch {
              resetDb();
            }
          }

          async function resetDb() {
            busy.value = true;
            try {
              await apiFetch("/demo/reset-db", { method: "POST" });
              antd.message.success("数据已重置");
              clearConversation();
              await refreshMe();
              await refreshDataSources();
              await refreshExamples();
            } catch (e) {
              antd.message.error(e.message || "重置失败");
            } finally {
              busy.value = false;
            }
          }

          async function runAutoDemo() {
            if (didAutoDemo.value) return;
            if (!me.value) return;
            if (messages.value.some((m) => !!m.result)) return;
            didAutoDemo.value = true;

            input.value = "按月统计火警趋势";
            await send();
          }

          async function runSql(m) {
            if (!m || !m.sqlDraft || !m.sqlDraft.trim()) return;
            busy.value = true;
            try {
              const res = await apiFetch("/sql/run", {
                method: "POST",
                body: JSON.stringify({
                  sql: m.sqlDraft,
                  datasource_ids: selectedDataSources.value,
                  question: m.result ? m.result.question : null,
                }),
              });
              m.result = res;
              m.sqlDraft = res.sql || m.sqlDraft;
              m.viewMode = pickDefaultView(res);
              m.expanded = true;
              scheduleRenderMsgChart(m);
            } catch (e) {
              antd.message.error(e.message || "执行失败");
            } finally {
              busy.value = false;
            }
          }

          async function copySql(m) {
            const text = ((m && m.sqlDraft) || "").trim();
            if (!text) return;
            try {
              await navigator.clipboard.writeText(text);
              antd.message.success("SQL已复制");
            } catch (e) {
              try {
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.setAttribute("readonly", "readonly");
                ta.style.position = "fixed";
                ta.style.left = "-9999px";
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                document.body.removeChild(ta);
                antd.message.success("SQL已复制");
              } catch (e2) {
                antd.message.error("复制失败，请手动复制");
              }
            }
          }

          async function pinToDashboard(m) {
            if (!m || !m.result || !m.result.result_id) return;
            try {
              const cfg = resolveChartConfig(m);
              const payload = { result_id: m.result.result_id };
              if (cfg && cfg.type && cfg.type !== "table") payload.chart = cfg;
              await apiFetch("/charts/pin", { method: "POST", body: JSON.stringify(payload) });
              antd.message.success("已上屏（打开图表大屏查看）");
            } catch (e) {
              antd.message.error(e.message || "上屏失败");
            }
          }

          function exportExcel(m) {
            const r = m && m.result;
            if (!r || !r.data || !r.data.length) return;
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(r.data);
            XLSX.utils.book_append_sheet(wb, ws, "data");
            const fname = `智能问数_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fname);
          }

          function exportPdf(m) {
            // 走浏览器打印为PDF（无需额外依赖）
            const r = m && m.result;
            if (!r) return;
            const html = `
              <html><head><meta charset="utf-8"><title>导出PDF</title></head>
              <body style="font-family: Arial, 'PingFang SC', 'Microsoft YaHei';">
                <h2>智能问数导出</h2>
                <p><b>问题：</b>${(r.question || "").replaceAll("<","&lt;")}</p>
                <pre style="background:#f3f4f6; padding:10px; border-radius:8px;">${(r.sql || "").replaceAll("<","&lt;")}</pre>
                <h3>思考过程</h3>
                <pre>${(r.analysis || "").replaceAll("<","&lt;")}</pre>
                <h3>数据（前50行）</h3>
                ${renderTableHtml((r.data || []).slice(0,50))}
              </body></html>`;
            const w = window.open("", "_blank");
            if (!w) return;
            w.document.open();
            w.document.write(html);
            w.document.close();
            w.focus();
            setTimeout(() => {
              try { w.print(); } catch {}
            }, 150);
          }

          function renderTableHtml(rows) {
            if (!rows.length) return "<div>无数据</div>";
            const cols = Object.keys(rows[0]);
            const th = cols.map(c=>`<th style="border:1px solid #ddd; padding:6px; background:#fafafa;">${escapeHtml(c)}</th>`).join("");
            const trs = rows.map(r=>`<tr>${cols.map(c=>`<td style="border:1px solid #ddd; padding:6px;">${escapeHtml(String(r[c] ?? ''))}</td>`).join("")}</tr>`).join("");
            return `<table cellspacing="0" cellpadding="0" style="border-collapse:collapse; font-size:12px;">${th?`<thead><tr>${th}</tr></thead>`:""}<tbody>${trs}</tbody></table>`;
          }

          function escapeHtml(s) {
            return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
          }

          const persistChatState = () => {
            saveChatState({
              conversations: conversations.value,
              activeConversationId: activeConversationId.value,
            });
          };

          watch(conversations, () => {
            if (!activeConversation.value && conversations.value.length) {
              activeConversationId.value = conversations.value[0].id;
            }
            persistChatState();
          }, { deep: true });

          watch(activeConversationId, () => {
            persistChatState();
            disposeAllCharts();
            nextTick(() => {
              messages.value.forEach((m) => {
                if (m && m.result) scheduleRenderMsgChart(m);
              });
              scrollBottom();
            });
          }, { immediate: true });

          watch(selectedDataSources, (val) => {
            saveDatasourceSelection(val || []);
          }, { deep: true });

          onMounted(async () => {
            applyBrandToShell(brand.value);
            window.addEventListener("smartask-auth-required", () => {
              showLogin.value = true;
            });

            await refreshMe();
            if (me.value) {
              await refreshDataSources();
              await refreshExamples();
              await runAutoDemo();
            } else {
              showLogin.value = true;
            }

            window.addEventListener("resize", () => {
              for (const inst of charts.values()) {
                try { inst.resize(); } catch {}
              }
            });
          });

          return {
            me,
            brand,
            showBrandEditor,
            brandForm,
            openBrandEditor,
            saveBrand,
            resetBrand,
            showAccountManager,
            users,
            userForm,
            userFormLoading,
            openAccountManager,
            createUser,
            confirmDeleteUser,
            openResetPassword,
            showResetPassword,
            resetPassword,
            submitResetPassword,
            showLogin,
            login,
            loginError,
            busy,
            chatting,
            confirmResetDb,
            dataSources,
            selectedDataSources,
            dataSourceOptions,
            examples,
            examplePreview,
            messages,
            activeConversationId,
            conversationOptions,
            newConversation,
            clearConversation,
            input,
            chatLog,
            resultCount,
            tableColumnsFor,
            tableDataFor,
            hasChart,
            hasRenderableChart,
            displayChartType,
            toggleExpand,
            onMsgViewModeChange,
            onChartTypeChange,
            setMsgChartEl,
            refreshDataSources,
            fillExample,
            resetChat,
            openDataSources,
            doLogin,
            logout,
            send,
            runDemo,
            runSql,
            copySql,
            pinToDashboard,
            exportExcel,
            exportPdf,
            demoRunning,
            showAddSource,
            showAddTable,
            showUploadTable,
            addSource,
            addTable,
            addSourceLoading,
            addTableLoading,
            uploadTable,
            uploadTableLoading,
            uploadSheetOptions,
            uploadRows,
            uploadPreviewRows,
            uploadPreviewColumns,
            submitAddSource,
            submitAddTable,
            handleUploadFileChange,
            onUploadSheetChange,
            submitUploadTable,
            chartTypeOptions,
            dbTypeOptions,
          };
        }
      });
      try {
        app.use(antd);
        app.mount("#app");
        const el = document.getElementById("app");
        if (el) el.removeAttribute("v-cloak");
      } catch (e) {
        try {
          const msg = (e && (e.message || e.toString())) || "未知错误";
          const loading = document.querySelector(".boot-loading");
          if (loading) loading.textContent = `加载失败：${msg}`;
        } catch {}
      }
    </script>
  </body>
</html>
{% endraw %}
