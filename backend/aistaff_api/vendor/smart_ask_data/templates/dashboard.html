{% raw %}
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图表大屏 - 广东省消防救援总队数据治理（2024）项目</title>

    <link href="static/vendor/ant-design-vue/reset.css" rel="stylesheet" />
    <link href="static/app_shell.css" rel="stylesheet" />
    <script src="static/vendor/vue/vue.global.prod.js"></script>
    <script src="static/vendor/dayjs/dayjs.min.js"></script>
    <script src="static/vendor/dayjs/plugin/advancedFormat.js"></script>
    <script src="static/vendor/dayjs/plugin/customParseFormat.js"></script>
    <script src="static/vendor/dayjs/plugin/quarterOfYear.js"></script>
    <script src="static/vendor/dayjs/plugin/weekday.js"></script>
    <script src="static/vendor/dayjs/plugin/localeData.js"></script>
    <script src="static/vendor/dayjs/plugin/weekOfYear.js"></script>
    <script src="static/vendor/dayjs/plugin/weekYear.js"></script>
    <script>
      if (window.dayjs_plugin_advancedFormat) dayjs.extend(window.dayjs_plugin_advancedFormat);
      if (window.dayjs_plugin_customParseFormat) dayjs.extend(window.dayjs_plugin_customParseFormat);
      if (window.dayjs_plugin_quarterOfYear) dayjs.extend(window.dayjs_plugin_quarterOfYear);
      if (window.dayjs_plugin_weekday) dayjs.extend(window.dayjs_plugin_weekday);
      if (window.dayjs_plugin_localeData) dayjs.extend(window.dayjs_plugin_localeData);
      if (window.dayjs_plugin_weekOfYear) dayjs.extend(window.dayjs_plugin_weekOfYear);
      if (window.dayjs_plugin_weekYear) dayjs.extend(window.dayjs_plugin_weekYear);
    </script>
    <script src="static/vendor/ant-design-vue/antd-with-locales.min.js"></script>
    <script src="static/vendor/echarts/echarts.min.js"></script>

    <style>
      :root {
        --bg: #070a14;
        --text: rgba(229, 231, 235, 0.92);
        --muted: rgba(229, 231, 235, 0.72);
        --border: rgba(255, 255, 255, 0.12);
        --surface: rgba(255, 255, 255, 0.06);
        --surface2: rgba(255, 255, 255, 0.04);
        --shadow: 0 22px 64px rgba(0, 0, 0, 0.45);
        --radius: 16px;
        --primary: #7c3aed;
        --accent: #06b6d4;
        --good: #22c55e;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        background:
          radial-gradient(1000px circle at 10% -10%, rgba(124, 58, 237, 0.38) 0%, rgba(124, 58, 237, 0) 60%),
          radial-gradient(900px circle at 100% 0%, rgba(6, 182, 212, 0.26) 0%, rgba(6, 182, 212, 0) 55%),
          linear-gradient(180deg, #070a14 0%, #0b1220 55%, #070a14 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      .muted { color: var(--muted); font-size: 12px; }

      .hd {
        position: sticky;
        top: 0;
        z-index: 10;
        height: 72px;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 16px;
        padding: 0 20px;
        background: rgba(7, 10, 20, 0.72);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
      }
      .hd::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 70%, var(--good) 100%);
      }
      .hd > * { position: relative; }

      .title-row { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
      .title { font-size: 18px; font-weight: 900; letter-spacing: 0.4px; }
      .actions { display:flex; gap: 10px; flex-wrap: wrap; justify-content:flex-end; }

      .grid {
        width: min(1600px, 100%);
        margin: 0 auto;
        padding: 18px;
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 16px;
      }

      .kpi-strip {
        width: min(1600px, 100%);
        margin: 0 auto;
        padding: 14px 18px 0;
        display:grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      .kpi {
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.12);
        background: linear-gradient(135deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.04) 100%);
        box-shadow: var(--shadow);
        padding: 12px 14px;
        overflow: hidden;
        position: relative;
      }
      .kpi::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(600px circle at 10% 0%, rgba(124, 58, 237, 0.18) 0%, rgba(124, 58, 237, 0) 55%);
        opacity: 0.7;
        pointer-events: none;
      }
      .kpi > * { position: relative; }
      .kpi-label { display:flex; align-items:center; justify-content:space-between; gap: 10px; color: var(--muted); font-size: 12px; }
      .kpi-value { margin-top: 6px; font-size: 22px; font-weight: 950; letter-spacing: .2px; }
      .kpi-sub { margin-top: 2px; color: rgba(229, 231, 235, 0.62); font-size: 11px; }
      .kpi-skel { height: 86px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.10); background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.10) 40%, rgba(255,255,255,0.05) 80%); background-size: 200% 100%; animation: shimmer 1.1s infinite; }
      @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: -200% 0; } }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.04) 100%);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: var(--radius);
        overflow:hidden;
        box-shadow: var(--shadow);
      }
      .card:hover { border-color: rgba(124, 58, 237, 0.32); }
      .card-hd {
        padding: 12px 14px;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
      }
      .card-title { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; font-weight: 800; }
      .card-bd { padding: 10px 14px 14px; }
      .chart { width: 100%; height: 340px; border-radius: 14px; }
      .analysis { margin-top: 10px; color: var(--muted); line-height: 1.55; white-space: pre-wrap; }

      .empty-card {
        grid-column: 1 / -1;
        padding: 26px;
        text-align: center;
      }
      .empty-title { font-weight: 900; font-size: 18px; margin-bottom: 6px; }

      .ant-input {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.16);
        color: var(--text);
        border-radius: 12px;
      }
      .ant-input::placeholder { color: rgba(229, 231, 235, 0.55); }
      .ant-input:focus, .ant-input-focused {
        border-color: rgba(6, 182, 212, 0.55);
        box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.16);
      }
      .ant-btn { border-radius: 12px; }
      .ant-btn-default {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.16);
        color: var(--text);
      }
      .ant-btn-default:hover {
        border-color: rgba(124, 58, 237, 0.40);
        color: var(--text);
      }
      .ant-btn-primary {
        border: none;
        background: linear-gradient(135deg, rgba(124, 58, 237, 1) 0%, rgba(6, 182, 212, 1) 100%);
      }
      .ant-btn-primary:hover { opacity: 0.95; }
      .ant-btn-dangerous {
        background: rgba(239, 68, 68, 0.16);
        border-color: rgba(239, 68, 68, 0.45);
        color: rgba(255,255,255,0.92);
      }

      .ant-tag {
        border-radius: 999px;
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.14);
        color: var(--text);
      }

      @media (max-width: 1400px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
      @media (max-width: 980px) {
        .grid { grid-template-columns: 1fr; }
        .kpi-strip { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .ask-input { width: min(560px, 100%) !important; }
      }
      @media (max-width: 560px) { .kpi-strip { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="shell">
      <aside class="sidebar">
        <div class="side-brand">
          <div class="side-logo" data-brand="sideLogo">粤消</div>
          <div>
            <div class="side-title" data-brand="projectName">广东省消防救援总队数据治理（2024）项目</div>
          </div>
        </div>
        <nav class="side-nav">
          <a class="side-link" href="./"><span>智能问数</span><span class="side-badge">AI</span></a>
          <a class="side-link" href="./datasources"><span>数据源</span><span class="side-badge">DATA</span></a>
          <a class="side-link" href="./data-dev"><span>数据开发</span><span class="side-badge">DEV</span></a>
          <a class="side-link active" href="./dashboard"><span>图表大屏</span><span class="side-badge">BI</span></a>
        </nav>
        <div class="side-tip">
          <b>提示：</b>可直接“提问上屏”，或先在智能问数页点“上屏”再来查看。
        </div>
      </aside>
      <div id="app" class="shell-content">
      <div class="hd">
        <div class="hd-left">
          <div class="title-row">
            <div class="title">图表大屏</div>
            <a-tag color="geekblue">{{ charts.length }} 张</a-tag>
          </div>
          <div class="muted">{{ brand.projectName }} · 智能问数上屏结果（无上屏时自动生成示例图表）</div>
        </div>
        <div class="actions">
          <template v-if="me">
            <a-tag color="geekblue">{{ me.username }}</a-tag>
            <a-tag>{{ me.role }}</a-tag>
            <a-button type="default" @click="showLogin=true">切换账号</a-button>
            <a-button type="text" @click="logout">退出</a-button>
          </template>
          <template v-else>
            <a-button type="primary" @click="showLogin=true">登录</a-button>
          </template>
          <a-input
            v-model:value="askText"
            placeholder="在大屏直接提问：例如 按月统计火警趋势"
            class="ask-input"
            style="width: 420px;"
            :disabled="asking || !me"
            @pressEnter="askAndPin"
          />
          <a-button type="primary" @click="askAndPin" :loading="asking" :disabled="!me">提问上屏</a-button>
          <a-button @click="refresh" :loading="busy" :disabled="!me">刷新</a-button>
        </div>
      </div>

      <div class="kpi-strip">
        <template v-if="metrics">
          <div class="kpi">
            <div class="kpi-label"><span>火警总量</span><a-tag>全部</a-tag></div>
            <div class="kpi-value">{{ metrics.alarm_total }}</div>
            <div class="kpi-sub">累计记录</div>
          </div>
          <div class="kpi">
            <div class="kpi-label"><span>近7天火警</span><a-tag>7d</a-tag></div>
            <div class="kpi-value">{{ metrics.alarm_7d }}</div>
            <div class="kpi-sub">近一周新增</div>
          </div>
          <div class="kpi">
            <div class="kpi-label"><span>今日未处理</span><a-tag>待办</a-tag></div>
            <div class="kpi-value">{{ metrics.alarm_unprocessed_today }}</div>
            <div class="kpi-sub">需要跟进</div>
          </div>
          <div class="kpi">
            <div class="kpi-label"><span>30天检查均分</span><a-tag>检查</a-tag></div>
            <div class="kpi-value">{{ metrics.inspection_avg_score_30d ?? '-' }}</div>
            <div class="kpi-sub">监督检查得分</div>
          </div>
        </template>
        <template v-else>
          <div class="kpi-skel" v-for="i in 4" :key="i"></div>
        </template>
      </div>

      <div class="grid">
        <div v-if="!charts.length" class="card empty-card">
          <div class="empty-title">暂无图表</div>
          <div class="muted" style="max-width: 720px; margin: 0 auto 14px;">请先在“智能问数”页点击“上屏”，或点击“刷新”自动生成一组示例图表。</div>
          <div style="display:flex; gap: 10px; justify-content:center; flex-wrap: wrap;">
            <a-button type="primary" @click="refresh" :loading="busy">生成示例图表</a-button>
            <a-button @click="back">去问数页上屏</a-button>
          </div>
        </div>

        <div v-for="c in charts" :key="c.result_id" class="card">
          <div class="card-hd">
            <div class="card-title">
              <span>{{ c.chart?.title || (c.question || '图表') }}</span>
              <a-tag v-if="c.chart?.type">{{ c.chart.type }}</a-tag>
              <a-tag v-if="c.count !== undefined && c.count !== null">{{ c.count }}条</a-tag>
            </div>
            <div style="display:flex; gap: 8px;">
              <a-button size="small" danger @click="remove(c.result_id)">移除</a-button>
            </div>
          </div>
          <div class="card-bd">
            <div :id="`chart_${c.result_id}`" class="chart"></div>
            <div class="analysis">{{ c.analysis }}</div>
          </div>
        </div>
      </div>

      <a-modal v-model:open="showLogin" title="登录" :footer="null" :maskClosable="false" width="420">
        <a-form layout="vertical" :model="login" @finish="doLogin">
          <a-form-item label="用户名" name="username" :rules="[{ required: true, message: '请输入用户名' }]">
            <a-input v-model:value="login.username"></a-input>
          </a-form-item>
          <a-form-item label="密码" name="password" :rules="[{ required: true, message: '请输入密码' }]">
            <a-input-password v-model:value="login.password"></a-input-password>
          </a-form-item>
          <div class="muted" v-if="loginError" style="color:#f87171; margin-bottom: 10px;">{{ loginError }}</div>
          <div style="display:flex; justify-content:flex-end; gap: 8px;">
            <a-button @click="showLogin=false">取消</a-button>
            <a-button type="primary" html-type="submit" :loading="busy">登录</a-button>
          </div>
        </a-form>
      </a-modal>
    </div>
    </div>

    <script>
      const { createApp, ref, nextTick, onMounted } = Vue;

      function apiFetch(path, options = {}) {
        return fetch(new URL("api" + path, window.location.href), {
          credentials: "include",
          headers: { "Content-Type": "application/json", ...(options.headers || {}) },
          ...options,
        }).then(async (r) => {
          const text = await r.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch {}
          if (!r.ok) {
            if (r.status === 401) {
              try { window.dispatchEvent(new CustomEvent("smartask-auth-required")); } catch {}
            }
            const msg = (json && (json.detail || json.message)) || text || `HTTP ${r.status}`;
            throw new Error(msg);
          }
          return json;
        });
      }

      const BRAND_STORAGE_KEY = "smartask_brand_config_v1";

      function defaultBrandConfig() {
        return {
          projectName: "广东省消防救援总队数据治理（2024）项目",
          sideLogo: "粤消",
        };
      }

      function loadBrandConfig() {
        try {
          const raw = localStorage.getItem(BRAND_STORAGE_KEY);
          const data = raw ? JSON.parse(raw) : null;
          return { ...defaultBrandConfig(), ...(data || {}) };
        } catch {
          return defaultBrandConfig();
        }
      }

      function applyBrandToShell(config) {
        const mapping = {
          sideLogo: config && config.sideLogo,
          projectName: config && config.projectName,
        };
        Object.entries(mapping).forEach(([key, val]) => {
          if (!val) return;
          document.querySelectorAll(`[data-brand="${key}"]`).forEach((el) => {
            el.textContent = val;
          });
        });
      }

      function buildOption(cfg, rows) {
        const type = (cfg && cfg.type) || "table";
        if (!cfg || !rows || !rows.length || type === "table") return null;

        const option = { title: { text: cfg.title || "" , textStyle:{ color:'#e5e7eb' } }, tooltip: {}, grid: { left: 40, right: 20, top: 60, bottom: 40 } };
        option.textStyle = { color: "#e5e7eb" };

        if (["line", "bar", "area", "bar_group", "bar_stack", "bar_horizontal"].includes(type)) {
          const xField = cfg.xField;
          const yField = cfg.yField;
          const yFields = cfg.yFields;
          const seriesField = cfg.seriesField;
          const valueField = cfg.valueField || yField;
          const isLine = type === "line" || type === "area";
          const isHorizontal = type === "bar_horizontal";
          const stackKey = type === "bar_stack" ? "total" : undefined;

          let categories = rows.map((r) => r[xField]);
          let series = [];
          if (seriesField) {
            const seriesNames = Array.from(new Set(rows.map((r) => r[seriesField])));
            const categoryNames = Array.from(new Set(rows.map((r) => r[xField])));
            const lookup = new Map();
            for (const row of rows) {
              lookup.set(`${row[seriesField]}||${row[xField]}`, row[valueField]);
            }
            categories = categoryNames;
            series = seriesNames.map((name) => ({
              name,
              type: isLine ? "line" : "bar",
              stack: stackKey,
              smooth: isLine,
              areaStyle: type === "area" ? { opacity: 0.12 } : undefined,
              data: categoryNames.map((cat) => lookup.get(`${name}||${cat}`) ?? 0),
            }));
          } else if (Array.isArray(yFields) && yFields.length) {
            series = yFields.map((field) => ({
              name: field,
              type: isLine ? "line" : "bar",
              stack: stackKey,
              smooth: isLine,
              areaStyle: type === "area" ? { opacity: 0.12 } : undefined,
              data: rows.map((r) => r[field]),
            }));
          } else {
            series = [{ type: isLine ? "line" : "bar", data: rows.map((r) => r[valueField]) }];
          }

          if (isHorizontal) {
            option.xAxis = { type: "value", axisLabel:{ color:'#e5e7eb' } };
            option.yAxis = { type: "category", data: categories, axisLabel:{ color:'#e5e7eb' } };
          } else {
            option.xAxis = { type: "category", data: categories, axisLabel:{ color:'#e5e7eb' } };
            option.yAxis = { type: "value", axisLabel:{ color:'#e5e7eb' } };
          }
          option.series = series;
        } else if (type === "pie") {
          const nameField = cfg.nameField;
          const valueField = cfg.valueField;
          option.series = [{
            type: "pie",
            radius: "70%",
            data: rows.map((r) => ({ name: r[nameField], value: r[valueField] })),
            label: { color: "#e5e7eb" }
          }];
        } else if (type === "heatmap") {
          const xField = cfg.xField;
          const yField = cfg.yField;
          const valueField = cfg.valueField;
          const xs = Array.from(new Set(rows.map((r) => r[xField])));
          const ys = Array.from(new Set(rows.map((r) => r[yField])));
          const data = rows.map((r) => [xs.indexOf(r[xField]), ys.indexOf(r[yField]), r[valueField]]);
          option.xAxis = { type: "category", data: xs, axisLabel:{ color:'#e5e7eb' } };
          option.yAxis = { type: "category", data: ys, axisLabel:{ color:'#e5e7eb' } };
          option.visualMap = { min: 0, max: Math.max(...rows.map((r) => r[valueField] || 0)), calculable: true, orient: "horizontal", left: "center", bottom: 0, textStyle:{ color:'#e5e7eb' } };
          option.series = [{ type: "heatmap", data }];
          option.grid.bottom = 70;
        } else if (type === "scatter") {
          const xField = cfg.xField;
          const yField = cfg.yField;
          option.xAxis = { type: "value", axisLabel:{ color:'#e5e7eb' } };
          option.yAxis = { type: "value", axisLabel:{ color:'#e5e7eb' } };
          option.series = [{ type: "scatter", data: rows.map((r) => [r[xField], r[yField]]) }];
        }
        return option;
      }

      const app = createApp({
        setup() {
          const busy = ref(false);
          const asking = ref(false);
          const askText = ref("");
          const me = ref(null);
          const brand = ref(loadBrandConfig());
          const showLogin = ref(false);
          const login = ref({ username: "", password: "" });
          const loginError = ref("");
          const charts = ref([]);
          const metrics = ref(null);
          const metricsLoading = ref(false);
          const chartInstances = new Map();

          async function refreshMetrics() {
            metricsLoading.value = true;
            try {
              const res = await apiFetch("/metrics");
              metrics.value = res.data || null;
            } catch (e) {
              metrics.value = null;
            } finally {
              metricsLoading.value = false;
            }
          }

          async function refreshMe() {
            try {
              const res = await apiFetch("/auth/me");
              me.value = res.user || null;
            } catch {
              me.value = null;
            }
          }

          async function doLogin() {
            busy.value = true;
            loginError.value = "";
            try {
              await apiFetch("/auth/login", { method: "POST", body: JSON.stringify(login.value) });
              showLogin.value = false;
              await refreshMe();
              await refresh();
            } catch (e) {
              loginError.value = e.message || "登录失败";
            } finally {
              busy.value = false;
            }
          }

          async function logout() {
            await apiFetch("/auth/logout", { method: "POST" });
            me.value = null;
            showLogin.value = true;
          }

          async function refresh() {
            busy.value = true;
            try {
              if (!me.value) {
                showLogin.value = true;
                return;
              }
              const [res] = await Promise.all([apiFetch("/charts"), refreshMetrics()]);
              charts.value = res.data || [];
              if (!charts.value.length) {
                try {
                  const seeded = await apiFetch("/demo/seed-dashboard", { method: "POST" });
                  charts.value = seeded.data || [];
                } catch {}
              }
              await nextTick();
              renderAll();
            } catch (e) {
              const msg = e && e.message ? e.message : "";
              if (msg.includes("未登录") || msg.includes("401")) {
                showLogin.value = true;
                return;
              }
              antd.message.error(e.message || "刷新失败（请先登录并从问数页上屏）");
            } finally {
              busy.value = false;
            }
          }

          function renderAll() {
            for (const c of charts.value) {
              const el = document.getElementById(`chart_${c.result_id}`);
              if (!el) continue;
              let inst = chartInstances.get(c.result_id);
              if (!inst) {
                inst = echarts.init(el);
                chartInstances.set(c.result_id, inst);
              }
              const option = buildOption(c.chart, c.data);
              if (option) inst.setOption(option, true);
              else inst.clear();
            }
          }

          async function remove(resultId) {
            try {
              await apiFetch(`/charts/${resultId}`, { method: "DELETE" });
              await refresh();
            } catch (e) {
              antd.message.error(e.message || "移除失败");
            }
          }

          async function askAndPin() {
            const q = askText.value.trim();
            if (!q) return;
            if (!me.value) {
              showLogin.value = true;
              return;
            }
            asking.value = true;
            try {
              const res = await apiFetch("/chat", { method: "POST", body: JSON.stringify({ question: q }) });
              if (res && res.result_id) {
                await apiFetch("/charts/pin", { method: "POST", body: JSON.stringify({ result_id: res.result_id }) });
              }
              askText.value = "";
              await refresh();
              antd.message.success("已上屏");
            } catch (e) {
              antd.message.error(e.message || "提问上屏失败（请先在问数页登录）");
            } finally {
              asking.value = false;
            }
          }

          function back() {
            window.location.href = "/";
          }

          onMounted(async () => {
            applyBrandToShell(brand.value);
            window.addEventListener("smartask-auth-required", () => {
              showLogin.value = true;
            });
            await refreshMe();
            if (me.value) {
              await refresh();
            } else {
              showLogin.value = true;
            }
          });

          return {
            busy,
            asking,
            askText,
            me,
            brand,
            showLogin,
            login,
            loginError,
            doLogin,
            logout,
            charts,
            metrics,
            metricsLoading,
            refresh,
            remove,
            askAndPin,
            back,
          };
        },
      });
      app.use(antd);
      app.mount("#app");
    </script>
  </body>
</html>
{% endraw %}
